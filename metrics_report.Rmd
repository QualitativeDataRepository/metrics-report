---
title: "Metrics report"
author: "Qualitative Data Repository"
date: "Generated `r Sys.time()`"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE) 
opts <- options(knitr.kable.NA = "")
library(httr)
library(readr)
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggfortify)
source("helper.R")

# Institutional members
members <-
  c(
    "American University",
    "Brown University",
    "Case Western",
    "Columbia University",
    "Cornell University",
    "Duke University",
    "Fordham",
    "George Mason",
    "George Washington University",
    "Macalester",
    "Marine Corps",
    "3ie",
    "New York University",
    "Palliative Care Research Cooperative",
    "Princeton University",
    "Syracuse University",
    "University of California, Berkeley|UC Berkeley",
    "California, Merced",
    "University of Cincinnati",
    "University of Iowa",
    "University of Maryland Baltimore",
    "University of Michigan",
    "University of New Mexico",
    "University of North Carolina at Chapel Hill",
    "University of Texas at Austin",
    "Villanova University",
    "Virginia Tech",
    "West Virginia"
  )
# Add the prospective institutional member
extend <- Sys.getenv("extend_im")
if (extend!="") members <- c(members, extend)


# Set tokens and file location settings
dataverse_host <- "http://data.qdr.syr.edu"
dataverse_key <- Sys.getenv("DATAVERSE_TOKEN")
drupal_folder <- paste0(Sys.getenv("EXTERNAL_GH_FOLDER"), "/drupal")

# Calculate dates
period_begin <- as.Date(paste(as.integer(format(Sys.Date(), "%Y"))-1,
                              "01-01", sep = "-"))
period_end <- as.Date(paste(as.integer(format(Sys.Date(), "%Y"))-1,
                              "12-31", sep = "-"))

# Drupal data, format as necessary
use <- read_csv(paste0(drupal_folder, "/use-stats.csv"))
login <- read_csv(paste0(drupal_folder, "/login-history.csv"))

#login <- login[complete.cases(login), ]
login$Created <- as.Date(login$Created, format = "%m/%d/%Y")
login$`Last login` <- as.Date(login$`Last login`, format = "%a, %m/%d/%Y - %R")
login$Institution <- toupper(login$Institution)
login$Institution <- trimws(login$Institution)
login$full_name <- with(login, paste(`Last Name`, `First Name`, sep=", "))

# This runs the helper function
login$member <- checkif_member(login) # Needs the extension too!

# Basic statistics
drupal_users <- nrow(login)
# How many logins before a user is considered a "frequent flyer"?
login$frequent_flyer <- login$`Logins during time period` > 10
drupal_new_users <- sum(login$Created < period_end & login$Created > period_begin)

drupal_all_logins <- sum(login$`Logins during time period`)
drupal_unique_logins <- sum(login$`Last login` > period_begin)
drupal_logins_without_ff <- sum(login$`Logins during time period`[!login$frequent_flyer])

# Dataverse data
dataverse <- paste0(dataverse_host, "/api/info/metrics")
# This implements the search API to get all available data for all datasets
deposits <- content(GET(paste0(dataverse_host,
                               "/api/search/?q=*&type=dataset&per_page=1000"),
                        config=add_headers("X-Dataverse-Key"=dataverse_key)))
deposits <- tibble(deposit=deposits$data$items)
deposits <- deposits %>% unnest_wider(deposit)

# Check for institutional members
institutions <- lapply(deposits$global_id, FUN=function(x, key) {
  metadata <- content(GET(paste0("http://data.qdr.syr.edu",
         "/api/datasets/:persistentId/?persistentId=", 
         x), config=add_headers("X-Dataverse-Key"=key)))
  
  metadata <- 
    tibble(info=metadata$data$latestVersion$metadataBlocks$citation$fields) %>% 
    unnest_wider(info)
  
  affiliations <-
    metadata %>% filter(typeName == "author") %>% select("value") %>%
    unnest_auto(value) %>% unnest_auto(value)
  
  # check if there's no affiliation entry in the metadata
  if (is.null(affiliations$authorAffiliation)) {
    return(NA)
  }
  
  affiliations %>%
    select("authorAffiliation") %>% unnest_wider(authorAffiliation) %>%
    select("value") %>% .$value
}, dataverse_key)

regex <- paste0("\\b(?:", paste(members, collapse="|"), ")\\b")
matches <- lapply(institutions, function(x, regex) {
  matches <- stringr::str_extract(x, regex)
  dplyr::first(na.omit(matches))
}, regex)
deposits$member <- unlist(matches)

deposits$name <- stringr::str_trunc(deposits$name, 75, "right")
deposits$versionState <- recode(deposits$versionState, RELEASED="Published", DRAFT="Unpublished")
```

## Parameters

- Special period: `r period_begin` to `r period_end`.
- Extensions to institutional member list: `r extend`

## Drupal

- QDR currently has `r drupal_users` users registered in Drupal. 
- `r drupal_new_users` of those users were created between `r period_begin` and `r period_end`.
- `r drupal_unique_logins` unique users have logged in since `r period_begin`.

Based on the time period used to generate the drupal login csv file:

- There have been `r drupal_all_logins` logins. 
- If we subtract the "frequent flyers" (10 logins/user), this number drops to `r drupal_logins_without_ff`.  

```{r drupal}
login %>% group_by(Institution) %>% summarise(users=length(`User status`)) %>% 
  arrange(desc(users)) %>% slice(1:10) %>%
  knitr::kable(row.names = FALSE, col.names = c("Institution", "Affiliated users"),
               caption="Top institutional affiliations by number of users")

use %>% select(-`Views today`) %>% arrange(desc(`Total views`)) %>% 
  slice(1:10) %>%
  mutate(Title = paste0("[", Title, "](", 
                      "https://qdr.syr.edu", `Link to Content`, ")")) %>%
  select(!`Link to Content`) %>%
  knitr::kable(row.names = FALSE, col.names = c("Title", "Views"),
               caption="Most accessed drupal pages")
```

```{r members_drupal}
members_drupal <- count(group_by(login, member))

members_drupal <- login %>% group_by(member) %>% summarize(logins=sum(`Logins during time period`)) %>% full_join(members_drupal)

login %>% group_by(member) %>% filter(Created < period_end & Created > period_begin) %>% 
  summarize(created_since=length(`Name/Email`)) %>% full_join(members_drupal) %>%
  arrange(desc(n)) %>% # replace_na(list(created_since=0)) %>%
  knitr::kable(col.names = c("Institution", paste("Created between", 
                                                  period_begin, "and", period_end),
                             "Logins", "Total users"),
               caption="User statistics of institutional member drupal accounts")
```

## Dataverse

```{r total_projects}
dataverse_total <- nrow(deposits)
deposits_new <- sum(as.Date(deposits$createdAt) < period_end & as.Date(deposits$createdAt) > period_begin)
```

- There are currently `r dataverse_total` projects. 
- `r deposits_new` are from the period between `r period_begin` and `r period_end`.

```{r subject}
deposits %>% group_by(versionState) %>% summarize(n=n()) %>%
  knitr::kable(caption="Deposits by publication status", col.names=c("Status", "Deposits"))

deposits %>% select(c("versionState", "subjects")) %>%
  unnest_longer(subjects) %>% group_by(versionState, subjects) %>%
  summarize(pct=round(100*(n()/nrow(deposits)), digits=2)) %>%
  knitr::kable(caption="Deposits by subject", 
               col.names=c("Status", "Subject", "Percentage of projects"))

deposits %>% filter(as.Date(createdAt) < period_end &
                      as.Date(createdAt) > period_begin) %>%
  select(c("versionState", "subjects")) %>%
  unnest_longer(subjects) %>% group_by(versionState, subjects) %>%
  summarize(pct=round(100*(n()/nrow(deposits)), digits=2)) %>%
  knitr::kable(caption=paste("Deposits by subject between", period_begin,
                             "and", period_end),
               col.names=c("Status", "Subject", "Percentage of projects"))
```

```{r top}
projects <- content(GET(paste0(dataverse, "/uniquedownloads/monthly")))
projects <- bind_rows(projects$data)
projects$date <- as.Date(paste0(projects$date, "-01"))

projects %>% group_by(pid) %>% summarize(sum(count)) %>% 
  arrange(desc(`sum(count)`)) %>% slice(1:5) %>%
  mutate(pid = paste0("[", deposits$name[deposits$global_id %in% pid], "](", 
                      "https://data.qdr.syr.edu/dataset.xhtml?persistentId=", 
                      pid, ")")) %>%
  knitr::kable(caption="Top 5 all time downloaded projects",
             row.names = FALSE, col.names = c("Project", "Downloads"))

projects %>% group_by(pid) %>% filter(date < period_end) %>% 
  summarize(sum(count)) %>% arrange(desc(`sum(count)`)) %>% slice(1:5) %>%
  mutate(pid = paste0("[", deposits$name[deposits$global_id %in% pid], "](", 
                      "https://data.qdr.syr.edu/dataset.xhtml?persistentId=", 
                      pid, ")")) %>%
  knitr::kable(caption=paste("Top 5 downloaded projects since", period_end),
             row.names = FALSE, col.names = c("Project", "Downloads"))
```


### Institutional members

```{r member_projects}
member_deposits <- deposits %>% filter(!is.na(member)) %>% 
  group_by(member, versionState) %>% 
  tally()
#  knitr::kable(caption = "Deposits associated with member", 
#               col.names = c("Institution", "Status", "Deposits"))

deposits %>% filter(!is.na(member) & as.Date(createdAt) > period_end) %>% 
  group_by(member, versionState) %>% 
  summarize(period=length(global_id)) %>% full_join(member_deposits) %>%
  knitr::kable(caption="Deposits associated with member",
               col.names = c("Institution", "Status", 
                             paste(period_begin, "to", period_end),
                             "Total"))

projects %>% group_by(global_id=pid) %>% summarize(downloads=sum(count)) %>%
  inner_join(deposits) %>% select("name", "global_id", "member", "downloads") %>%
  filter(!is.na(member)) %>% arrange(desc(downloads)) %>%
  group_by(member) %>% slice_head(n=3) %>%
  mutate(name = paste0("[", name, "](", 
                      "https://data.qdr.syr.edu/dataset.xhtml?persistentId=", 
                      global_id, ")")) %>% select(!global_id) %>%
  knitr::kable(caption="Top 3 downloads from each member institution",
               col.names = c("Deposit", "Member institution", "Downloads"),
               linesep = "\\addlinespace")
```

## Make Data Count
```{r views}
views_total <- content(GET(paste0(dataverse, '/makeDataCount/viewsTotal/monthly')))
views_total <- bind_rows(views_total$data)
names(views_total) <- c("date", "total")

views_unique <- content(GET(paste0(dataverse, '/makeDataCount/viewsUnique/monthly')))
views_unique <- bind_rows(views_unique$data)
names(views_unique) <- c("date", "unique")

both <- merge(views_total, views_unique, all=TRUE, by="date")
both_ts <- ts(both[, -1], frequency=12, 
              start=strsplit(both$date[1], split="-")[[1]])
autoplot(both_ts, facets = FALSE) + labs(title="Views", color="Statistic") 
```

```{r downloads}
downloads_total <- content(GET(paste0(dataverse, '/makeDataCount/downloadsTotal/monthly')))
downloads_total <- bind_rows(downloads_total$data)
names(downloads_total) <- c("date", "total")

downloads_unique <- content(GET(paste0(dataverse, '/makeDataCount/downloadsUnique/monthly')))
downloads_unique <- bind_rows(downloads_unique$data)
names(downloads_unique) <- c("date", "unique")

both <- merge(downloads_total, downloads_unique, all=TRUE, by="date")
both_ts <- ts(both[, -1], frequency=12, 
              start=strsplit(both$date[1], split="-")[[1]])
autoplot(both_ts, facets = FALSE) +  labs(title="Downloads", color="Statistic") 
```

