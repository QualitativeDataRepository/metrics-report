library(stringr)

#' checkif_member
#' 
#' for internal use only
#'
#' @param login Drupal login csv
#' @param im institutional membership table
#'
#' @return a factor set
checkif_member <- function(login, im) {
  login$Institution[login$Institution==""] <- NA # When the above line leaves nothing left, turn "" to NA
  #im$drupal <- str_replace_all(im$drupal, "[[:punct:]]", "")
  
  institution_match <- member_regexp(login$Institution, im)

  login$`Name/Email` <- str_extract(login$`Name/Email`, "[a-zA-Z0-9]+\\.edu$")
  email_match <- unlist(lapply(login$`Name/Email`, function(x, domain) {
    match <- str_which(domain, paste0("^", x, "$"))
    if (length(match)==0) return(NA) 
    return(match[1])
  }, str_to_lower(im$domain)))
  email_match <- factor(email_match, levels = 1:nrow(im), labels = im$canonical)
  
  
  matches <- dplyr::coalesce(institution_match, email_match)
  return(matches)
}

#' member_regexp
#' 
#' Use regexp to detect institutional members from free-form fields
#'
#' @param affiliations list of affiliations (i.e. generated by `deposit_affiliations()`)
#' @param im institutional membership tibble
#'
#' @return a factor vector of matches
member_regexp <- function(affiliations, im) {
  # Run all the depositor affiliations against a regex of institutional members
  regex <- paste0("\\b(?:", paste(im$regexp, collapse="|"), ")\\b")
  matches <- lapply(affiliations, function(x, regex) {
    if (is.vector(x)) x <- paste(unlist(x), collapse=" ")
    matches <- stri_extract_all_regex(x, regex, case_insensitive=TRUE)
    #matches <- stringr::str_extract(fixed(x, ignore_case), regex,)
    dplyr::first(na.omit(matches))
  }, regex)

  matches <- unlist(lapply(matches, function(x, im) {
    if (is.na(x)) return(NA)
    im$canonical[as.vector(!is.na(stri_extract_all_regex(im$regexp, x, case_insensitive=TRUE)))]
  }, im))
  
  factor(matches, levels=im$canonical, labels=im$canonical)
}

